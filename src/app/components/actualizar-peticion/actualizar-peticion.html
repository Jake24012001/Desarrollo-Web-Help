<form class="formulario-actualizar" (ngSubmit)="guardarCambios()" #actualizarForm="ngForm">
    <!-- Formulario en Bootstrap: conservar [(ngModel)] y names para ngForm -->
    <div class="container-fluid px-3 px-md-4">
        <div class="card shadow-sm rounded-3">
            <div class="card-body">
                <h2 class="h4 mb-3 text-dark border-bottom pb-2">Actualizar Petición #{{ datosticket.id_ticket }}</h2>

                <div class="row g-3">

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label for="titulo" class="form-label">Título</label>
                        <input type="text" id="titulo" class="form-control" [(ngModel)]="datosticket.title" name="title" required>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label class="form-label">ID Ticket</label>
                        <input type="text" class="form-control bg-light" [value]="datosticket.id_ticket" readonly>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label for="select-status" class="form-label">Estado</label>
                        <select id="select-status" class="form-select" [(ngModel)]="selectedStatusId" (change)="actualizarEstado()" name="statusId" required>
                            <option [value]="0">-- Seleccione un Estado --</option>
                            <option *ngFor="let estado of estadosDisponibles" [value]="estado.id_status">{{ estado.nombre }}</option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label for="select-priority" class="form-label">Prioridad</label>
                        <select id="select-priority" class="form-select" [(ngModel)]="selectedPriorityId" (change)="actualizarPrioridad()" name="priorityId" required>
                            <option [value]="0">-- Seleccione una Prioridad --</option>
                            <option *ngFor="let prioridad of prioridadesDisponibles" [value]="prioridad.id_priority">{{ prioridad.name }}</option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label for="select-usuario" class="form-label">Usuario Asignado</label>
                        <!-- Para CLIENTE: mostrar textbox con usuario logeado (solo lectura) -->
                        <input *ngIf="esCliente" 
                               type="text" 
                               class="form-control bg-light" 
                               [value]="nombreUsuarioLogeado" 
                               readonly>
                        <!-- Para ADMIN/AGENTE: mostrar select para elegir usuario -->
                        <select *ngIf="!esCliente"
                                id="select-usuario" 
                                class="form-select" 
                                [(ngModel)]="selectedUsuarioId" 
                                (change)="actualizarUsuarioAsignado()" 
                                name="usuarioAsignadoId" 
                                required>
                            <option [value]="0">-- Seleccione un Usuario (Admin/Agente) --</option>
                            <option *ngFor="let usuario of usuariosDisponibles" [value]="usuario.id_usuario"
                              [hidden]="!esAdmin && usuario.id_usuario !== usuarioLogeado?.idUsuario">
                                {{ usuario.nombre }}
                            </option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label for="select-equipo" class="form-label">Equipo Afectado</label>
                        <select id="select-equipo" class="form-select" [(ngModel)]="selectedEquipoId" (change)="actualizarEquipoAfectado()" name="equipoId" required>
                            <option [value]="0">N/A - Sin Equipo Afectado</option>
                            <option *ngFor="let equipo of equiposDisponibles" [value]="equipo.id">
                                {{ equipo.serial }} ({{ equipo.product.name }})
                                <span *ngIf="equipo.product.brand || equipo.product.model">
                                    - {{ equipo.product.brand }}{{ equipo.product.brand && equipo.product.model ? ' ' : '' }}{{ equipo.product.model }}
                                </span>
                            </option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label class="form-label">Creador</label>
                        <input type="text" class="form-control bg-light" [value]="datosticket.usuario_creador?.nombre" readonly>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label class="form-label">Fecha de Creación</label>
                        <input type="text" class="form-control bg-light" [value]="datosticket.fecha_creacion | date: 'medium'" readonly>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-4">
                        <label class="form-label">Fecha de Última Actualización</label>
                        <input type="text" class="form-control bg-light" [value]="datosticket.fecha_actualizacion | date: 'medium'" readonly>
                    </div>

                    <div class="col-12">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea id="descripcion" rows="4" class="form-control" [(ngModel)]="datosticket.descripcion" name="descripcion" required></textarea>
                    </div>

                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary w-100 submit-btn" [class.disabled]="!actualizarForm?.valid" [attr.disabled]="!actualizarForm?.valid ? true : null">Guardar Cambios del Ticket</button>
                </div>

            </div>
        </div>
    </div>
</form>