<div class="container-fluid py-4">
  <!-- Formulario de creación de ticket (original) -->
  <div class="card shadow-lg mt-4 mb-5 mx-auto" style="max-width: 600px;">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Creación de Ticket de Soporte</h5>
    </div>
    <div class="card-body">
      <form class="formulario-peticion" (ngSubmit)="crearTicket()">
        <!-- Tipo de petición -->
        <div class="form-group mb-3">
          <label for="tipoPeticion" class="form-label">Tipo de petición:</label>
          <input type="text" id="tipoPeticion" class="form-control" placeholder="Ingrese su petición"
            [(ngModel)]="tipoPeticion" name="tipoPeticion" required />
        </div>

        <!-- Selección de usuario -->
        <div class="form-group mb-3">
          <label for="usuario" class="form-label">Selecciona un usuario:</label>
          <select id="usuario" class="form-select" [(ngModel)]="usuarioSeleccionado" (change)="onUsuarioChange()" name="usuario" required>
            <option [ngValue]="null" disabled selected>-- Selecciona --</option>
            <option *ngFor="let usuario of usuarios" [ngValue]="usuario">{{ usuario.nombre }}</option>
          </select>
        </div>

        <!-- Categoría de equipo -->
        <div class="form-group mb-3">
          <label for="producto" class="form-label">
            Categoría de equipo
            <span *ngIf="!usuarioSeleccionado" class="text-muted small">(Selecciona un usuario primero)</span>
          </label>
          <select name="producto" id="producto" class="form-select" [(ngModel)]="productoSeleccionado"
            (change)="filtrarEquiposPorTipo()" [disabled]="!usuarioSeleccionado" required>
            <option value="" disabled selected>-- Selecciona --</option>
            <option *ngFor="let producto of productosUnicos" [value]="producto.type">{{ producto.type }}</option>
          </select>
        </div>

        <!-- Equipos disponibles -->
        <div class="form-group mb-3">
          <label for="equipo" class="form-label">
            Equipos disponibles:
            <span *ngIf="!usuarioSeleccionado" class="text-muted small">(Selecciona un usuario primero)</span>
          </label>
          <select id="equipo" class="form-select" [(ngModel)]="equipoSeleccionado" 
                  [disabled]="!usuarioSeleccionado || !productoSeleccionado" name="equipo" required>
            <option [ngValue]="null" disabled selected>-- Selecciona --</option>
            <option *ngFor="let equipo of equiposFiltrados" [ngValue]="equipo">
              {{ formatearEquipo(equipo) }}
            </option>
          </select>
        </div>

        <!-- Detalle de petición -->
        <div class="form-group mb-3">
          <label for="detallePeticion" class="form-label">Detalle de petición:</label>
          <textarea id="detallePeticion" class="form-control" rows="4" placeholder="Describa su problemática"
            [(ngModel)]="detallePeticion" name="detallePeticion" required></textarea>
        </div>

        <!-- Acciones -->
        <div class="d-flex gap-2 pt-3">
          <button type="submit" class="btn btn-primary btn-lg">Enviar</button>
          <button type="button" class="btn btn-outline-secondary btn-lg" (click)="cancelarAccion()">Cancelar</button>
        </div>

        <!-- Estado inicial -->
        <div class="form-group mt-4 pt-3 border-top">
          <label class="form-label">Estado inicial del ticket:</label>
          <div class="alert alert-success fw-bold p-2 mb-0">{{ getEstadoPendiente()?.nombre || 'ABIERTO' }}</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Sección: Mis Tickets -->
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Mis Tickets</h2>

    <!-- Barra de búsqueda -->
    <div class="mb-4">
      <input 
        type="text" 
        class="form-control form-control-lg" 
        placeholder="Buscar tickets por título, descripción o equipo..." 
        [(ngModel)]="searchTerm" 
        (input)="filtrarTickets()"
      />
    </div>

    <!-- Tickets Abiertos -->
    <div class="mb-5">
      <h4 class="mb-3 text-primary">
        <i class="bi bi-folder-open"></i> Tickets Abiertos ({{ ticketsAbiertos.length }})
      </h4>
      
      <div *ngIf="ticketsAbiertos.length === 0" class="alert alert-info">
        <i class="bi bi-info-circle"></i> 
        {{ searchTerm ? 'No se encontraron tickets que coincidan con tu búsqueda.' : 'No tienes tickets abiertos en este momento.' }}
      </div>

      <div class="row g-3">
        <div class="col-md-6 col-lg-4" *ngFor="let ticket of ticketsAbiertos">
          <div class="card h-100 shadow-sm border-start border-4 border-primary">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">{{ ticket.title }}</h5>
                <span 
                  class="badge rounded-pill" 
                  [ngClass]="getPrioridadClass(ticket.priority)"
                >
                  {{ ticket.priority?.name || 'Sin prioridad' }}
                </span>
              </div>

              <p class="card-text text-muted small mb-2">
                <i class="bi bi-calendar"></i> 
                {{ ticket.fecha_creacion ? (ticket.fecha_creacion | date:'dd/MM/yyyy HH:mm') : 'Fecha no disponible' }}
              </p>

              <p class="card-text" style="min-height: 60px;">
                {{ ticket.descripcion.length > 100 ? (ticket.descripcion.substring(0, 100) + '...') : ticket.descripcion }}
              </p>

              <div class="mt-3 pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge bg-success">{{ getEstadoTexto(ticket) }}</span>
                  <small class="text-muted" *ngIf="ticket.equipoAfectado">
                    <i class="bi bi-laptop"></i> {{ ticket.equipoAfectado.product?.name }}
                  </small>
                </div>
                
                <div *ngIf="ticket.usuario_asignado" class="mt-2">
                  <small class="text-muted">
                    <i class="bi bi-person-badge"></i> Asignado a: {{ ticket.usuario_asignado.nombre }}
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tickets Resueltos -->
    <div>
      <h4 class="mb-3 text-success">
        <i class="bi bi-check-circle"></i> Tickets Resueltos ({{ ticketsResueltos.length }})
      </h4>
      
      <div *ngIf="ticketsResueltos.length === 0" class="alert alert-secondary">
        <i class="bi bi-check-circle"></i> 
        {{ searchTerm ? 'No se encontraron tickets resueltos que coincidan con tu búsqueda.' : 'Aún no tienes tickets resueltos.' }}
      </div>

      <div class="row g-3">
        <div class="col-md-6 col-lg-4" *ngFor="let ticket of ticketsResueltos">
          <div class="card h-100 shadow-sm border-start border-4 border-success">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">{{ ticket.title }}</h5>
                <span class="badge bg-success">Cerrado</span>
              </div>

              <p class="card-text text-muted small mb-2">
                <i class="bi bi-calendar-check"></i> 
                {{ ticket.fecha_cierre ? (ticket.fecha_cierre | date:'dd/MM/yyyy HH:mm') : (ticket.fecha_actualizacion | date:'dd/MM/yyyy HH:mm') }}
              </p>

              <p class="card-text" style="min-height: 60px;">
                {{ ticket.descripcion.length > 100 ? (ticket.descripcion.substring(0, 100) + '...') : ticket.descripcion }}
              </p>

              <div class="mt-3 pt-3 border-top">
                <div *ngIf="ticket.equipoAfectado" class="mb-2">
                  <small class="text-muted">
                    <i class="bi bi-laptop"></i> {{ ticket.equipoAfectado.product?.name }}
                  </small>
                </div>

                <!-- Calificación existente o botón para calificar -->
                <div *ngIf="ticket.puntuacion" class="alert alert-light mb-0 p-2">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">
                      <i class="bi bi-star-fill" *ngFor="let star of [1,2,3,4,5]" [class.text-muted]="star > ticket.puntuacion!"></i>
                    </span>
                    <span class="fw-bold">{{ ticket.puntuacion }}/5</span>
                  </div>
                  <small class="text-muted" *ngIf="ticket.comentario_calificacion">
                    "{{ ticket.comentario_calificacion }}"
                  </small>
                </div>

                <button 
                  *ngIf="!ticket.puntuacion" 
                  class="btn btn-sm btn-outline-warning w-100"
                  (click)="calificarServicio(ticket)"
                >
                  <i class="bi bi-star"></i> Calificar servicio
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>