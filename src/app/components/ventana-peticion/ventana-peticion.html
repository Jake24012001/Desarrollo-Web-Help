<div class="card shadow-lg mt-4 mb-5 mx-auto" style="max-width: 600px;">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Creación de Ticket de Soporte</h5>
  </div>
  <div class="card-body">
    <!-- Formulario para crear ticket -->
    <form class="formulario-peticion" (ngSubmit)="crearTicket()">

      <!-- Tipo de petición -->
      <div class="form-group mb-3">
        <label for="tipoPeticion" class="form-label">Tipo de petición:</label>
        <input type="text" id="tipoPeticion" class="form-control" placeholder="Ingrese su petición"
          [(ngModel)]="tipoPeticion" name="tipoPeticion" required />
      </div>

      <!-- Selección de usuario -->
      <div class="form-group mb-3">
        <label for="usuario" class="form-label">Usuario creador:</label>
        <!-- Si es ADMIN, mostrar select para elegir usuario -->
        <select *ngIf="authorizationService.isAdmin()" id="usuario" class="form-select" [(ngModel)]="usuarioSeleccionado" name="usuario" required>
          <option value="" disabled selected>-- Selecciona --</option>
            <option *ngFor="let usuario of usuarios" [ngValue]="usuario">{{ usuario.apellidos }} {{ usuario.nombres }} — {{ usuario.cedula }}</option>
        </select>
        <!-- Si NO es ADMIN, mostrar textbox readonly con el usuario actual -->
          <div *ngIf="!authorizationService.isAdmin()" class="form-control" style="background-color: #f8f9fa; padding: 10px;">
            <div class="fw-bold">{{ usuarioSeleccionado?.apellidos }} {{ usuarioSeleccionado?.nombres }}</div>
            <small class="text-muted">Cédula: {{ usuarioSeleccionado?.cedula }}</small>
          </div>
          <input *ngIf="!authorizationService.isAdmin()" type="hidden" name="usuario" [(ngModel)]="usuarioSeleccionado" />
      </div>

      <!-- Asignar trabajo (usuario+rol) -->
      <div class="form-group mb-3" *ngIf="authorizationService.isAdmin()">
        <label for="asignarTrabajo" class="form-label">Asignar Trabajo</label>
        <select id="asignarTrabajo" class="form-select" [(ngModel)]="usuarioSeleccionados" name="usuarioAsignado">
          <option value="" disabled selected>-- Selecciona --</option>
          <!-- Mostrar solo usuarios con rol ADMIN o AGENTE; mostrar nombre y apellidos en vez de apodo -->
          <option *ngFor="let item of getRolesAdminYAgente()" [ngValue]="item">
            {{ item.rol.nombre }} - {{ (item.usuario.nombres || item.usuario.nombre) + (item.usuario.apellidos ? ' ' + item.usuario.apellidos : '') }}
          </option>
        </select>
      </div>

      <!-- Categoría de equipo y equipos disponibles -->
      <div class="form-group mb-3">
        <label for="producto" class="form-label">Categoría de equipo</label>
        <select name="producto" id="producto" class="form-select" [(ngModel)]="productoSeleccionado"
          (change)="filtrarEquiposPorTipo()" required>
          <option value="" disabled selected>-- Selecciona --</option>
          <option *ngFor="let producto of productosUnicos" [value]="producto.type">{{ producto.type }}</option>
        </select>
      </div>

      <div class="form-group mb-3">
        <label for="equipo" class="form-label">Equipos disponibles:</label>
        <div class="d-flex gap-2">
          <select id="equipo" class="form-select equipo-select" [(ngModel)]="equipoSeleccionado" name="equipo" required>
            <option value="" disabled selected *ngIf="!equiposFiltrados || equiposFiltrados.length === 0">
              ── Selecciona una categoría primero ──
            </option>
            <option *ngFor="let equipo of equiposFiltrados" [ngValue]="equipo">
              {{ formatearEquipo(equipo) }}
            </option>
          </select>
        </div>
      </div>

      <!-- Prioridad y detalle -->
      <div class="form-group mb-3">
        <label for="prioridad" class="form-label">Prioridad del ticket:</label>

        <!-- Si es ADMIN: permitir seleccionar prioridad -->
        <select *ngIf="authorizationService.isAdmin()" id="prioridad" class="form-select" [(ngModel)]="prioridadSeleccionada" name="prioridad" required>
          <option value="" disabled selected>-- Selecciona --</option>
          <option *ngFor="let prioridad of ticketPrioridades" [ngValue]="prioridad">{{ prioridad.name }}</option>
        </select>

        <!-- Si NO es ADMIN: mostrar mensaje fijo indicando que el admin asignará la prioridad -->
        <div *ngIf="!authorizationService.isAdmin()" class="form-control" style="background-color: #f8f9fa; padding: 10px;">
          <div class="fw-bold text-muted">La prioridad será asignada por un administrador.</div>
        </div>
        <!-- No enviar prioridad en el form si no es admin (dejar null para que admin la asigne) -->
      </div>

      <div class="form-group mb-3">
        <label for="detallePeticion" class="form-label">Detalle de petición:</label>
        <textarea id="detallePeticion" class="form-control" rows="4" placeholder="Describa su problemática"
          [(ngModel)]="detallePeticion" name="detallePeticion" required></textarea>
      </div>

      <!-- Acciones -->
      <div class="d-flex gap-2 pt-3">
        <button type="button" class="btn btn-primary btn-lg" (click)="crearTicket()">Enviar</button>
        <button type="button" class="btn btn-outline-secondary btn-lg" (click)="cancelarAccion()">Cancelar</button>
      </div>

      <!-- Estado inicial -->
      <div class="form-group mt-4 pt-3 border-top">
        <label class="form-label">Estado inicial del ticket:</label>
        <div class="alert alert-success fw-bold p-2 mb-0" role="alert">{{ getEstadoPendiente()?.nombre || 'ABIERTO' }}</div>
      </div>

    </form>
  </div>
</div>