<div class="card shadow-lg mt-4 mb-5 mx-auto" style="max-width: 600px;">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Creación de Ticket de Soporte</h5>
  </div>
  <div class="card-body">
    <form class="formulario-peticion" (ngSubmit)="crearTicket()">

      <div class="form-group mb-3">
        <label for="tipoPeticion" class="form-label">Tipo de petición:</label>
        <input type="text" id="tipoPeticion" class="form-control" 
          [class.is-invalid]="esCampoInvalido('tipoPeticion')"
          placeholder="Ingrese su petición"
          [(ngModel)]="tipoPeticion" 
          name="tipoPeticion" 
          (blur)="marcarCampoTocado('tipoPeticion')"
          required />
        <div class="invalid-feedback" *ngIf="esCampoInvalido('tipoPeticion')">
          El tipo de petición es requerido
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="usuario" class="form-label">Usuario creador:</label>
        <select *ngIf="authorizationService.isAdmin()" 
          id="usuario" 
          class="form-select" 
          [class.is-invalid]="esCampoInvalido('usuario')"
          [(ngModel)]="usuarioSeleccionado" 
          name="usuario" 
          (blur)="marcarCampoTocado('usuario')"
          required>
          <option value="" disabled selected>-- Selecciona --</option>
            <option *ngFor="let usuario of usuarios" [ngValue]="usuario">{{ usuario.apellidos }} {{ usuario.nombres }} — {{ usuario.cedula }}</option>
        </select>
        <div class="invalid-feedback" *ngIf="authorizationService.isAdmin() && esCampoInvalido('usuario')">
          Debe seleccionar un usuario creador
        </div>
          <div *ngIf="!authorizationService.isAdmin()" class="form-control" style="background-color: #f8f9fa; padding: 10px;">
            <div class="fw-bold">{{ usuarioSeleccionado?.apellidos }} {{ usuarioSeleccionado?.nombres }}</div>
            <small class="text-muted">Cédula: {{ usuarioSeleccionado?.cedula }}</small>
          </div>
          <input *ngIf="!authorizationService.isAdmin()" type="hidden" name="usuario" [(ngModel)]="usuarioSeleccionado" />
      </div>

      <div class="form-group mb-3" *ngIf="authorizationService.isAdmin()">
        <label for="asignarTrabajo" class="form-label">Asignar Trabajo</label>
        <select id="asignarTrabajo" class="form-select" [(ngModel)]="usuarioSeleccionados" name="usuarioAsignado">
          <option value="" disabled selected>-- Selecciona --</option>
          <option *ngFor="let item of getRolesAdminYAgente()" [ngValue]="item">
            {{ item.rol.nombre }} - {{ (item.usuario.nombres || item.usuario.nombre) + (item.usuario.apellidos ? ' ' + item.usuario.apellidos : '') }}
          </option>
        </select>
      </div>

      <div class="form-group mb-3">
        <label for="producto" class="form-label">Categoría de equipo</label>
        <select name="producto" 
          id="producto" 
          class="form-select" 
          [class.is-invalid]="esCampoInvalido('producto')"
          [(ngModel)]="productoSeleccionado"
          (change)="filtrarEquiposPorTipo()" 
          (blur)="marcarCampoTocado('producto')"
          required>
          <option value="" disabled selected>-- Selecciona --</option>
          <option *ngFor="let producto of productosUnicos" [value]="producto.type">{{ producto.type }}</option>
        </select>
        <div class="invalid-feedback" *ngIf="esCampoInvalido('producto')">
          Debe seleccionar una categoría de equipo
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="productoNombre" class="form-label">Nombre del Producto:</label>
        <select id="productoNombre" 
          class="form-select" 
          [class.is-invalid]="esCampoInvalido('productoNombre')"
          [(ngModel)]="productoNombreSeleccionado" 
          (change)="onProductoNombreSeleccionado()" 
          (blur)="marcarCampoTocado('productoNombre')"
          name="productoNombre" 
          [disabled]="!equiposFiltrados || equiposFiltrados.length === 0">
          <option [ngValue]="''" *ngIf="!productoNombreSeleccionado" disabled selected>── Selecciona un producto ──</option>
          <option *ngFor="let nombre of obtenerNombresUnicos()" [value]="nombre">{{ nombre }}</option>
        </select>
        <div class="invalid-feedback" *ngIf="esCampoInvalido('productoNombre')">
          Debe seleccionar el nombre del producto
        </div>
      </div>

      <div class="form-group mb-3" *ngIf="productoNombreSeleccionado">
        <label for="equipo" class="form-label">Equipo específico (Serial / Modelo / Código):</label>
        <select id="equipo" 
          class="form-select equipo-select" 
          [class.is-invalid]="esCampoInvalido('equipo')"
          [(ngModel)]="equipoSeleccionado" 
          (change)="onEquipoSeleccionado()" 
          (blur)="marcarCampoTocado('equipo')"
          name="equipo" 
          required>
          <option [ngValue]="null" *ngIf="!equipoSeleccionado" disabled selected>── Selecciona el equipo ──</option>
          <option *ngFor="let equipo of equiposDelProducto" [ngValue]="equipo">
            {{ formatearEquipoDetalle(equipo) }}
          </option>
        </select>
        <div class="invalid-feedback" *ngIf="esCampoInvalido('equipo')">
          Debe seleccionar un equipo
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="prioridad" class="form-label">Prioridad del ticket:</label>

        <select *ngIf="authorizationService.isAdmin()" 
          id="prioridad" 
          class="form-select" 
          [class.is-invalid]="esCampoInvalido('prioridad')"
          [(ngModel)]="prioridadSeleccionada" 
          name="prioridad" 
          (blur)="marcarCampoTocado('prioridad')"
          required>
          <option value="" disabled selected>-- Selecciona --</option>
          <option *ngFor="let prioridad of ticketPrioridades" [ngValue]="prioridad">{{ prioridad.name }}</option>
        </select>
        <div class="invalid-feedback" *ngIf="authorizationService.isAdmin() && esCampoInvalido('prioridad')">
          Debe seleccionar una prioridad
        </div>

        <div *ngIf="!authorizationService.isAdmin()" class="form-control" style="background-color: #f8f9fa; padding: 10px;">
          <div class="fw-bold text-muted">La prioridad será asignada por un administrador.</div>
        </div>
      </div>

      <div class="form-group mb-3" *ngIf="authorizationService.isAdmin()">
        <label for="fechaEstimada" class="form-label">Fecha estimada de resolución:</label>
        <input 
          type="datetime-local" 
          id="fechaEstimada" 
          class="form-control" 
          [class.is-invalid]="esCampoInvalido('fechaEstimada')"
          [(ngModel)]="fechaEstimada" 
          name="fechaEstimada"
          (blur)="marcarCampoTocado('fechaEstimada')"
          (change)="marcarCampoTocado('fechaEstimada')"
          [min]="obtenerFechaMinima()"
          required>
        <div class="invalid-feedback" *ngIf="esCampoInvalido('fechaEstimada')">
          <span *ngIf="!fechaEstimada || !fechaEstimada.trim()">Debe establecer una fecha estimada de resolución</span>
          <span *ngIf="fechaEstimada && fechaEstimadaExpirada()">La fecha y hora seleccionada ya pasó. Debe ser futura.</span>
        </div>
        <small class="text-muted d-block mt-1" *ngIf="!esCampoInvalido('fechaEstimada')">
          <i class="bi bi-info-circle"></i> Seleccione la fecha y hora en que espera resolver este ticket
        </small>
        <small class="text-danger d-block mt-1 fw-bold" *ngIf="fechaEstimada && fechaEstimadaExpirada()">
          <i class="bi bi-exclamation-triangle-fill"></i> Fecha límite en el pasado
        </small>
      </div>

      <div class="form-group mb-3">
        <label for="detallePeticion" class="form-label">Detalle de petición:</label>
        <textarea id="detallePeticion" 
          class="form-control" 
          [class.is-invalid]="esCampoInvalido('detallePeticion')"
          rows="4" 
          placeholder="Describa su problemática"
          [(ngModel)]="detallePeticion" 
          name="detallePeticion" 
          (blur)="marcarCampoTocado('detallePeticion')"
          required></textarea>
        <div class="invalid-feedback" *ngIf="esCampoInvalido('detallePeticion')">
          El detalle de la petición es requerido
        </div>
      </div>

      <div class="d-flex gap-2 pt-3">
        <button type="button" 
          class="btn btn-primary btn-lg" 
          (click)="crearTicket()"
          [disabled]="!esFormularioValido()">
          Enviar
        </button>
        <button type="button" class="btn btn-outline-secondary btn-lg" (click)="cancelarAccion()">Cancelar</button>
      </div>

      <div class="form-group mt-4 pt-3 border-top">
        <label class="form-label">Estado inicial del ticket:</label>
        <div class="alert alert-success fw-bold p-2 mb-0" role="alert">{{ getEstadoPendiente()?.nombre || 'ABIERTO' }}</div>
      </div>

    </form>
  </div>
</div>