<div class="container-fluid px-4">
  <!-- Barra de búsqueda y filtros -->
  <div class="d-flex align-items-center gap-2 my-3 justify-content-between">
    <!-- Campo de búsqueda con placeholder dinámico -->
    <div class="d-flex align-items-center gap-2">
      <input type="text" class="form-control form-control-sm search-input" [placeholder]="placeholderText"
        [(ngModel)]="terminoBusqueda" (input)="filtrarDatos()" />
      <button class="btn btn-primary btn-sm" (click)="limpiarBusqueda()">Limpiar</button>
    </div>
    <!-- Filtro de vista (todos/pendientes/resueltos) -->
    <div class="d-flex align-items-center">
      <label for="filtroTicketsTop" class="visually-hidden">Filtro de tickets</label>
      <select id="filtroTicketsTop" class="header-filter-select ms-2" [(ngModel)]="filtroTickets" (change)="aplicarFiltroTickets()" aria-label="Filtro de tickets">
        <option value="todos">Mostrar todos</option>
        <option value="pendientes">Tickets pendientes</option>
        <option value="resueltos">Tickets resueltos</option>
      </select>
    </div>
  </div>

  <!-- Tabla de tickets pendientes (header azul) -->
  <div *ngIf="filtroTickets === 'todos' || filtroTickets === 'pendientes'" class="tickets-card mb-4">
    <div class="card-header-custom">
      <div class="header-left">
        <h5 class="mb-0 text-white fw-bold"><i class="bi bi-clipboard-check me-2"></i>Tickets Pendientes</h5>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover tabla-tickets mb-0">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Problema</th>
            <th>Descripción</th>
            <th>Asignado</th>
            <th>Equipo</th>
            <th>Creador</th>
            <th>Prioridad</th>
            <th>Tiempo</th>
            <!-- La columna Acciones solo la ven admin y agentes -->
            <th *ngIf="!authorizationService.isCliente()">Acciones</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of datosFiltradosPendientes; let i = index">
            <td class="text-nowrap">
              <span *ngIf="item.fecha_creacion">{{ item.fecha_creacion | date:'short' }}</span>
              <span *ngIf="!item.fecha_creacion">—</span>
            </td>
            <!-- Título del ticket -->
            <td class="td-truncate">{{ item.title || '—' }}</td>
            <!-- Descripción con botón para ver detalle completo -->
            <td class="td-descripcion">
              <span class="descripcion-texto">{{ item.descripcion || '—' }}</span>
              <button *ngIf="item.descripcion" class="btn-ver-mas" (click)="verDescripcionCompleta(item)" title="Ver descripción completa">
                <i class="bi bi-eye"></i>
              </button>
            </td>
            <!-- Usuario asignado: nombre completo y email -->
            <td>
              <span *ngIf="item.usuario_asignado">
                {{ item.usuario_asignado.nombres || item.usuario_asignado.nombre || '—' }}
                {{ item.usuario_asignado.apellidos || '' }}
                <br>
                <small class="text-muted">
                  <i class="bi bi-envelope"></i> {{ item.usuario_asignado.email || '—' }}
                </small>
              </span>
              <span *ngIf="!item.usuario_asignado">—</span>
            </td>
            <!-- Equipo afectado: nombre, marca y modelo si existen -->
            <td class="td-truncate">
              <span *ngIf="item.equipoAfectado?.product">
                {{ item.equipoAfectado?.product?.name || '—' }}
                <span *ngIf="item.equipoAfectado?.product?.brand || item.equipoAfectado?.product?.model" class="equipo-detalles">
                  <br>
                  <small class="text-muted">
                    <span *ngIf="item.equipoAfectado?.product?.brand">{{ item.equipoAfectado?.product?.brand }}</span>
                    <span *ngIf="item.equipoAfectado?.product?.brand && item.equipoAfectado?.product?.model"> - </span>
                    <span *ngIf="item.equipoAfectado?.product?.model">{{ item.equipoAfectado?.product?.model }}</span>
                  </small>
                </span>
              </span>
              <span *ngIf="!item.equipoAfectado?.product">—</span>
            </td>
            <!-- Creador del ticket: nombre completo y email -->
            <td>
              <span *ngIf="item.usuario_creador">
                {{ item.usuario_creador.nombres || item.usuario_creador.nombre || '—' }}
                {{ item.usuario_creador.apellidos || '' }}
                <br>
                <small class="text-muted">
                  <i class="bi bi-envelope"></i> {{ item.usuario_creador.email || '—' }}
                </small>
              </span>
              <span *ngIf="!item.usuario_creador">—</span>
            </td>
            <!-- Prioridad con color según nivel (alta/media/baja) -->
            <td>
              <span class="prioridad-text" [class.prioridad-alta]="item.priority?.name === 'ALTA'"
                [class.prioridad-media]="item.priority?.name === 'MEDIA'"
                [class.prioridad-baja]="item.priority?.name === 'BAJA'">
                {{ item.priority?.name || '—' }}
              </span>
            </td>
            <!-- Tiempo transcurrido - parpadea en rojo si se excedió el plazo -->
            <td class="text-nowrap tiempo-cell" [class.tiempo-excedido]="tiempoExcedido(item)">
              {{ item.tiempoRestante || '—' }}
            </td>
            <!-- Botones de acción: editar, eliminar y resolver (ocultos para clientes) -->
            <td *ngIf="!authorizationService.isCliente()">
              <div class="btn-group-actions">
                <button *ngIf="ticketAccessService.canEditTicket(item)" class="btn-action btn-edit" (click)="modificarPeticion(item)" title="Editar">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button *ngIf="ticketAccessService.canDeleteTicket(item)" class="btn-action btn-delete" (click)="borrarPeticion(i, 'pendiente')" title="Eliminar">
                  <i class="bi bi-trash3"></i>
                </button>
                <button *ngIf="ticketAccessService.canResolveTicket(item)" class="btn-action btn-resolve" (click)="marcarComoResuelta(item)" title="Marcar como resuelta">
                  <i class="bi bi-check-circle"></i>
                </button>
              </div>
            </td>
            <!-- Estado con clase dinámica para colores -->
            <td>
              <span [ngClass]="getClaseEstado(item.status?.nombre || '')" class="estado-label">
                {{ item.status?.nombre }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tabla de tickets resueltos (cerrados) -->
  <div *ngIf="filtroTickets === 'todos' || filtroTickets === 'resueltos'" class="tickets-card mb-4">
    <div class="card-header-success">
      <h5 class="mb-0 text-white fw-bold"><i class="bi bi-check-circle me-2"></i>Tickets Resueltos</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover tabla-tickets mb-0">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Asignado</th>
            <th>Equipo</th>
            <th>Creador</th>
            <th>Prioridad</th>
            <th>Tiempo</th>
            <!-- Columna eliminar solo para admin y agentes -->
            <th *ngIf="!authorizationService.isCliente()">Eliminar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of datosResueltos; let i = index">
            <!-- Fecha de creación -->
            <td class="text-nowrap">
              <span *ngIf="item.fecha_creacion">{{ item.fecha_creacion | date:'short' }}</span>
              <span *ngIf="!item.fecha_creacion">—</span>
            </td>
            <!-- Descripción con botón de ver más -->
            <td class="td-descripcion">
              <span class="descripcion-texto">{{ item.descripcion || '—' }}</span>
              <button *ngIf="item.descripcion" class="btn-ver-mas" (click)="verDescripcionCompleta(item)" title="Ver descripción completa">
                <i class="bi bi-eye"></i>
              </button>
            </td>
            <td>
              <span *ngIf="item.usuario_asignado">
                {{ item.usuario_asignado.nombres || item.usuario_asignado.nombre || '—' }}
                {{ item.usuario_asignado.apellidos || '' }}
                <br>
                <small class="text-muted">
                  <i class="bi bi-envelope"></i> {{ item.usuario_asignado.email || '—' }}
                </small>
              </span>
              <span *ngIf="!item.usuario_asignado">—</span>
            </td>
            <td class="td-truncate">
              <span *ngIf="item.equipoAfectado?.product">
                {{ item.equipoAfectado?.product?.name || '—' }}
                <span *ngIf="item.equipoAfectado?.product?.brand || item.equipoAfectado?.product?.model" class="equipo-detalles">
                  <br>
                  <small class="text-muted">
                    <span *ngIf="item.equipoAfectado?.product?.brand">{{ item.equipoAfectado?.product?.brand }}</span>
                    <span *ngIf="item.equipoAfectado?.product?.brand && item.equipoAfectado?.product?.model"> - </span>
                    <span *ngIf="item.equipoAfectado?.product?.model">{{ item.equipoAfectado?.product?.model }}</span>
                  </small>
                </span>
              </span>
              <span *ngIf="!item.equipoAfectado?.product">—</span>
            </td>
            <td>
              <span *ngIf="item.usuario_creador">
                {{ item.usuario_creador.nombres || item.usuario_creador.nombre || '—' }}
                {{ item.usuario_creador.apellidos || '' }}
                <br>
                <small class="text-muted">
                  <i class="bi bi-envelope"></i> {{ item.usuario_creador.email || '—' }}
                </small>
              </span>
              <span *ngIf="!item.usuario_creador">—</span>
            </td>
            <td>
              <span class="prioridad-text" [class.prioridad-alta]="item.priority?.name === 'ALTA'"
                [class.prioridad-media]="item.priority?.name === 'MEDIA'"
                [class.prioridad-baja]="item.priority?.name === 'BAJA'">
                {{ item.priority?.name || '—' }}
              </span>
            </td>
            <!-- Tiempo de resolución (desde creación hasta cierre) -->
            <td class="text-nowrap">
              <span *ngIf="item.fecha_cierre">{{ calcularTiempoRestante(item.fecha_cierre) }}</span>
              <span *ngIf="!item.fecha_cierre">—</span>
            </td>
            <!-- Botón eliminar (solo si tiene permiso) -->
            <td *ngIf="!authorizationService.isCliente()">
              <button *ngIf="ticketAccessService.canDeleteTicket(item)" class="btn-action btn-delete" (click)="borrarPeticion(i, 'resuelto')" title="Eliminar">
                <i class="bi bi-trash3"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Botón para crear nuevo ticket -->
  <div class="d-flex justify-content-end my-3">
    <button class="btn btn-success btn-crear shadow" (click)="crearPeticion()">
      <i class="bi bi-plus-circle me-2"></i> Crear Nuevo Ticket
    </button>
  </div>
</div>
